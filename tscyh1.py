import streamlit as st
from zhipuai import ZhipuAI

# ================= é…ç½®åŒºåŸŸ =================
# âš ï¸ å¡«å…¥ä½ çš„æ–° Key
API_KEY = "c2cd9f6ca9394c5c9284d5d547cb5cc4.yJxCm9sJ8tR11N3H"
# ===========================================

# åˆå§‹åŒ–å®¢æˆ·ç«¯
try:
    client = ZhipuAI(api_key=API_KEY)
except:
    pass


def generate_three_variations(user_input):
    """
    ç”µå•†è¯¦æƒ…é¡µä¸“ç”¨ v4.0ï¼š
    - ä¸¥æ ¼æ‰§è¡Œè¡£æœä¸æ–è£¤è…°
    - ä¸¥æ ¼é™å®šä¸‹è£…è¡¥å…¨ç±»å‹
    - ç»†åˆ†è§’åº¦ (1/5, 2/5...)
    - å¼ºåˆ¶ç™½å¤©å…‰çº¿
    """
    if not API_KEY or "è¯·åœ¨è¿™é‡Œ" in API_KEY:
        return ["âŒ é”™è¯¯ï¼šè¯·åœ¨ä»£ç ä¸­é…ç½®æ­£ç¡®çš„ API Key"] * 3

    # 1. èƒŒæ™¯åº“ (åŒ…å«çº¯è‰² + æ‚¨æŒ‡å®šçš„ä¸°å¯Œåœºæ™¯)
    bg_library = """
    - **çº¯è‰²ç±»**ï¼šç™½è‰²ã€æµ…ç±³è‰²ã€æµ…ç°è‰²ã€æ·±ç°è‰²ã€‚
    - **è‡ªç„¶åœºæ™¯**ï¼šå…¬å›­è‰åªã€æ£®æ—æ°§å§ã€å±±é‡è¥åœ°ã€æµ·è¾¹æ²™æ»©ã€éƒŠé‡è‰åœ°ã€å±±é¡¶å¹³å°ã€‚
    - **ç”Ÿæ´»/åŸå¸‚**ï¼šå®¤å†…ã€èŠ±å›­è‰åªã€æ ¡å›­è‰åªã€é‡é¤å«å‘¨è¾¹ã€éœ²è¥å¸ç¯·åŒºã€æˆ·å¤–é‡é¤åŒºã€éƒŠé‡é‡é¤ç‚¹ã€‚
    """

    # 2. è§’åº¦åº“ (æåº¦ç»†åˆ†ï¼Œæ‹’ç»æ­»æ¿)
    angle_library = """
    [ æ­£é¢, èƒŒé¢, ä¾§é¢, 
      äº”åˆ†ä¹‹ä¸€ä¾§é¢ (1/5 Side view), äº”åˆ†ä¹‹äºŒä¾§é¢ (2/5 Side view), 
      äº”åˆ†ä¹‹ä¸‰ä¾§é¢ (3/5 Side view), äº”åˆ†ä¹‹å››ä¾§é¢ (4/5 Side view),
      ä½å¤´, ä»°å¤´, ç•¥å¾®ä½å¤´, ç•¥å¾®ä»°å¤´, å›å¤´/å›çœ¸, 
      å¹³è§†, å°å¹…åº¦ä»°è§†, å°å¹…åº¦ä¿¯è§† ]
    """

    # 3. ä¸‹è£…è¡¥å…¨åº“ (ä¸¥æ ¼é™å®š)
    bottoms_library = "[ è£™å­, é˜”è…¿è£¤, ç›´ç­’è£¤, å·¥è£…è£¤, å¾®å–‡è£¤ ]"

    # 4. æ ¸å¿ƒ System Prompt
    system_instruction = f"""
    ä½ æ˜¯ä¸€ä½ç”µå•†è§†è§‰æ€»ç›‘ã€‚ç”¨æˆ·è¾“å…¥åŸå§‹æç¤ºè¯ï¼Œè¯·**ä¸€æ¬¡æ€§ç”Ÿæˆ 3 ä¸ªä¼˜åŒ–åçš„æç¤ºè¯æ–¹æ¡ˆ**ã€‚

    **åŸå§‹æç¤ºè¯**ï¼š{user_input}

    è¯·ä¸¥æ ¼æ‰§è¡Œä»¥ä¸‹ã€ä¹å¤§ç”µå•†é“å¾‹ã€‘ï¼š

    1. **å…‰çº¿ä¸æ—¶é—´ (Time Lock)**ï¼š
       - **é“å¾‹**ï¼šé™¤éåŸå§‹æç¤ºè¯æ˜ç¡®æåˆ°äº†â€œå¤•é˜³â€ã€â€œæ™šéœâ€ã€â€œå¤œæ™šâ€ï¼Œå¦åˆ™**ç»å¯¹ç¦æ­¢**ç”Ÿæˆé»„æ˜æˆ–å¤œæ™¯ï¼
       - **é»˜è®¤**ï¼šå¿…é¡»æ˜¯**å…‰çº¿å……è¶³çš„ç™½å¤© (Daylight, High-key)**ã€‚æ¨¡ç‰¹èº«ä¸Š**å°‘é«˜å…‰**ã€‚

    2. **ä¸Šè¡£ç©¿æ­ (Top Styling)**ï¼š
       - **é“å¾‹**ï¼šé™¤éåŸå§‹æç¤ºè¯æ˜ç¡®è¯´â€œæ–è¿›è£¤å­/å¡è¡£è§’â€ï¼Œå¦åˆ™**è¡£æœä¸‹æ‘†å¿…é¡»è‡ªç„¶å‚è½ (Untucked / Natural drop)**ï¼Œ**ä¸è¦**æ–åœ¨è£¤å­é‡Œã€‚

    3. **ä¸‹è£…è¡¥å…¨ (Bottoms Logic)**ï¼š
       - **é“å¾‹**ï¼šå¦‚æœåŸå§‹æç¤ºè¯æ²¡æœ‰æŒ‡å®šè£¤å­/ä¸‹è£…ï¼Œåªèƒ½ä»ä»¥ä¸‹åˆ—è¡¨ä¸­é€‰æ‹©æ­é…ï¼š
         {bottoms_library}
       - **å®Œæ•´æ€§**ï¼šæ¨¡ç‰¹å¿…é¡»ç©¿è£¤å­æˆ–è£™å­ï¼Œä¸¥ç¦ä¸‹åŠèº«å¤±è¸ªã€‚

    4. **é‹å­æ­é…**ï¼š
       - å‡¡æ˜¯ç”Ÿæˆå¸¦è„šéƒ¨çš„å›¾åƒï¼Œ**å¿…é¡»ç©¿é‹**ã€‚æ ¹æ®è¡£æœé£æ ¼æ­é…ï¼ˆè¿åŠ¨/ä¼‘é—²/æ½®ç‰Œ/æµè¡Œï¼‰ã€‚

    5. **æ¨¡ç‰¹è§„èŒƒ**ï¼š
       - **èº«ä»½**ï¼š**ä¸­å›½æ¨¡ç‰¹ (Chinese Model)**ã€‚
       - **æ€§åˆ«**ï¼šå¦‚æœåŸå§‹æç¤ºæ²¡æœ‰æŒ‡å®šæ€§åˆ«ï¼Œæ ¹æ®æœè£…è‡ªåŠ¨åˆ¤æ–­ï¼Œå¿…é¡»æœ‰æ€§åˆ«ã€‚
       - **ç”·æ¨¡**ï¼š**ä¸åŒ–å¦†ã€æ²¡æœ‰èƒ¡å­ (Clean-shaven)**ã€‚

    6. **æ„å›¾é€»è¾‘**ï¼š
       - ä¸Šè¡£ -> éœ²ä¸ŠåŠèº«æˆ–å…¨èº«ã€‚è£¤å­ -> éœ²ä¸‹åŠèº«æˆ–å…¨èº«ã€‚å¥—è£… -> å…¨èº«ã€‚

    7. **æœºä½ä¸åŠ¨ä½œ (å…³é”®)**ï¼š
       - **æ‹’ç»æ­»æ¿**ï¼3ä¸ªæ–¹æ¡ˆå°½é‡ä½¿ç”¨ä¸åŒçš„è§’åº¦(é™¤éåŸå§‹æç¤ºè¯æŒ‡å®š)ã€‚
       - å¿…é¡»å‚è€ƒï¼š{angle_library}ã€‚
       - è¯·åœ¨æè¿°ä¸­å‡†ç¡®ä½¿ç”¨å¦‚â€œäº”åˆ†ä¹‹äºŒä¾§é¢â€ã€â€œå°å¹…åº¦ä»°è§†â€ç­‰è¯æ±‡ã€‚

    8. **èƒŒæ™¯ä¸ç”»è´¨**ï¼š
       - å‚è€ƒ {bg_library}ã€‚3ä¸ªæ–¹æ¡ˆçš„èƒŒæ™¯ä¸è¦å¤ªå•ä¸€ï¼ˆé™¤éåŸå§‹æç¤ºè¯æŒ‡å®šï¼‰ã€‚
       - **è™šåŒ–æ§åˆ¶**ï¼š**è½»åº¦è™šåŒ– (Slight Depth of Field)**ï¼Œä¿ç•™ç¯å¢ƒè½®å»“ï¼Œ**æ‹’ç»**å¼ºçƒˆå¤§å…‰åœˆè™šåŒ–ã€‚

    9. **é¿å‘**ï¼š
       - ç”»é¢ä¸­**ç»å¯¹ä¸è¦å‡ºç°**æ‰“å…‰ç¯ã€åå…‰æ¿ç­‰æ‘„å½±è®¾å¤‡ã€‚

    **è¾“å‡ºæ ¼å¼**ï¼š
    è¯·ç›´æ¥è¾“å‡º 3 æ®µå†…å®¹ï¼Œæ¯æ®µä¹‹é—´ç”¨ "|||" ç¬¦å·åˆ†éš”ã€‚
    æ¯æ®µå†…å®¹æ˜¯ä¸€æ®µè¿è´¯çš„ä¸­æ–‡æè¿°ï¼Œä¸è¦åŠ æ ‡é¢˜ã€‚
    """

    try:
        response = client.chat.completions.create(
            model="glm-4",
            messages=[
                {"role": "system", "content": system_instruction},
                {"role": "user", "content": f"è¯·ä¸ºã€{user_input}ã€‘ç”Ÿæˆ3ä¸ªè¯¦æƒ…é¡µæ‹æ‘„æ–¹æ¡ˆ"}
            ],
            temperature=0.85,
            top_p=0.9
        )
        content = response.choices[0].message.content
        return [v.strip() for v in content.split("|||") if v.strip()]
    except Exception as e:
        return [f"API è°ƒç”¨å‡ºé”™: {e}"] * 3


# ================= ğŸ¨ Streamlit UI (å¹¶æ’å¤§æ¡†ç‰ˆ) =================

st.set_page_config(
    page_title="ç”µå•†è¯¦æƒ…é¡µç”Ÿå›¾å·¥å…·",
    page_icon="ğŸ›ï¸",
    layout="wide"  # ğŸ‘ˆ å®½å±æ¨¡å¼
)

# CSS æ·±åº¦ä¼˜åŒ–ï¼šè®© st.code è‡ªåŠ¨æ¢è¡Œï¼Œä¸”æ¡†è¶³å¤Ÿå¤§
st.markdown("""
<style>
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}

    /* ä¼˜åŒ–ä»£ç å—æ˜¾ç¤ºï¼šå¼ºåˆ¶æ¢è¡Œï¼Œå­—ä½“é€‚é…ä¸­æ–‡ */
    code {
        font-size: 15px !important; 
        font-family: "Microsoft YaHei", sans-serif !important;
        white-space: pre-wrap !important; /* å…³é”®ï¼šå¼ºåˆ¶æ¢è¡Œ */
    }

    /* å¢å¤§å¤åˆ¶æŒ‰é’®ï¼Œæ–¹ä¾¿ç‚¹å‡» */
    button[title="Copy to clipboard"] {
        transform: scale(1.2); 
    }

    /* è°ƒæ•´åˆ—é—´è· */
    div[data-testid="column"] {
        padding: 0px 8px;
    }
</style>
""", unsafe_allow_html=True)

# æ ‡é¢˜åŒº
st.title("ğŸ›ï¸ ç”µå•†æ¨¡ç‰¹æç¤ºè¯ä¼˜åŒ–å™¨ (Pro)")
st.caption("âœ¨ ç‰¹æ€§ï¼šä¸‰ç§æ–¹æ¡ˆ | è‡ªåŠ¨è¯†åˆ« | åŠ¨ä½œå¤šæ · | ç»†åˆ†è§’åº¦")

# è¾“å…¥åŒº
user_input = st.text_input("ğŸ‘— è¯·è¾“å…¥äººç‰©/åŠ¨ä½œ/æœè£…/èƒŒæ™¯æè¿°ï¼Œä¸æŒ‡å®šå°±ä¼šè‡ªè¡ŒåŒ¹é…",
                           placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªå¥³äººç©¿ç€ç™½è‰²çŸ­è¢–å’Œé»‘è‰²è£™å­åœ¨æˆ·å¤–é‡é¤")

if st.button("ğŸš€ ç”Ÿæˆ 3 å¥—æ–¹æ¡ˆ", type="primary", use_container_width=True):
    if not user_input:
        st.toast("âš ï¸ è¯·å…ˆè¾“å…¥æè¿°ï¼")
    else:
        with st.spinner("ğŸ§  è§†è§‰æ€»ç›‘æ­£åœ¨å«è‡ªå·±çš„å°å¼Ÿè°ƒåº¦æœºä½ã€æ­é…ä¸‹è£…..."):
            results = generate_three_variations(user_input)

        # è¡¥é½æ•°æ®ï¼Œé˜²æ­¢APIå¶å°”è¿”å›ä¸è¶³3ä¸ª
        while len(results) < 3:
            results.append("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•")

        st.success("âœ… ç”ŸæˆæˆåŠŸï¼è¯·ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®å¤åˆ¶ã€‚")

        # === æ ¸å¿ƒå¸ƒå±€ï¼šä¸‰åˆ—å¹¶æ’ ===
        col1, col2, col3 = st.columns(3)

        # æ–¹æ¡ˆ 1
        with col1:
            st.markdown("### ğŸ“¸ æ–¹æ¡ˆ A")
            st.caption("é£æ ¼/è§’åº¦ 1")
            # ä½¿ç”¨ text è¯­è¨€æ¨¡å¼ï¼Œé…åˆ CSS å®ç°è‡ªåŠ¨æ¢è¡Œå¤§æ¡†
            st.code(results[0], language="text")

        # æ–¹æ¡ˆ 2
        with col2:
            st.markdown("### ğŸ“¸ æ–¹æ¡ˆ B")
            st.caption("é£æ ¼/è§’åº¦ 2")
            st.code(results[1], language="text")

        # æ–¹æ¡ˆ 3
        with col3:
            st.markdown("### ğŸ“¸ æ–¹æ¡ˆ C")
            st.caption("é£æ ¼/è§’åº¦ 3")
            st.code(results[2], language="text")